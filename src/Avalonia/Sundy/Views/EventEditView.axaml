<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:Sundy.ViewModels"
             x:Class="Sundy.Views.EventEditView"
             x:DataType="vm:EventEditViewModel"
             xmlns:scheduler="using:Sundy.Controls.Scheduler"
             xmlns:controls="using:Sundy.Controls"
             MaxWidth="700"
             MinWidth="320"
             HorizontalAlignment="Stretch"
             Margin="16,24">

    <Border Background="{DynamicResource ModalBackground}"
            BorderBrush="{DynamicResource ModalBorder}"
            BorderThickness="1"
            CornerRadius="8"
            Padding="24"
            BoxShadow="0 4 16 0 #80000000">
        <Grid RowDefinitions="Auto,*,Auto">
            <!-- Header with Calendar Selection -->
            <Grid Grid.Row="0"
                  ColumnDefinitions="Auto,*"
                  Margin="0,0,0,24">
                <TextBlock Grid.Column="0"
                           Text="{Binding DialogTitle}"
                           FontSize="24"
                           FontWeight="SemiBold"
                           Foreground="{DynamicResource ForegroundPrimary}"
                           VerticalAlignment="Center"
                           Margin="0,0,12,0" />

                <!-- Calendar Selector as Clickable Label -->
                <Button Grid.Column="1"
                        IsEnabled="{Binding !IsBlockingEvent}"
                        Background="Transparent"
                        BorderThickness="0"
                        Padding="8,4"
                        Cursor="Hand"
                        VerticalAlignment="Center"
                        x:Name="CalendarSelectorButton">
                    <Button.Flyout>
                        <Flyout Placement="Bottom">
                            <Border Background="{DynamicResource BackgroundPrimary}"
                                    BorderBrush="{DynamicResource BorderBrush}"
                                    BorderThickness="1"
                                    CornerRadius="8"
                                    Padding="8"
                                    MinWidth="200"
                                    BoxShadow="0 4 12 0 #40000000">
                                <ItemsControl ItemsSource="{Binding AvailableCalendars}">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Button
                                                Command="{Binding $parent[UserControl].((vm:EventEditViewModel)DataContext).SelectCalendarCommand}"
                                                CommandParameter="{Binding}"
                                                Background="Transparent"
                                                BorderThickness="0"
                                                CornerRadius="6"
                                                HorizontalAlignment="Stretch"
                                                HorizontalContentAlignment="Left"
                                                Padding="8,6"
                                                Cursor="Hand">
                                                <Button.Styles>
                                                    <Style Selector="Button">
                                                        <Setter Property="Transitions">
                                                            <Transitions>
                                                                <BrushTransition Property="Background" Duration="0:0:0.15"/>
                                                            </Transitions>
                                                        </Setter>
                                                    </Style>
                                                    <Style Selector="Button:pointerover">
                                                        <Setter Property="Background" Value="{DynamicResource BackgroundSecondary}" />
                                                    </Style>
                                                </Button.Styles>
                                                <StackPanel Orientation="Horizontal" Spacing="8">
                                                    <Border Width="16"
                                                            Height="16"
                                                            Background="{Binding Color}"
                                                            CornerRadius="3" />
                                                    <TextBlock Text="{Binding Name}"
                                                               VerticalAlignment="Center"
                                                               Foreground="{DynamicResource ForegroundPrimary}" />
                                                </StackPanel>
                                            </Button>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </Border>
                        </Flyout>
                    </Button.Flyout>
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <Border Width="20"
                                Height="20"
                                Background="{Binding SelectedCalendar.Color}"
                                CornerRadius="4"
                                IsVisible="{Binding SelectedCalendar, Converter={x:Static ObjectConverters.IsNotNull}}" />
                        <TextBlock Text="{Binding SelectedCalendar.Name, FallbackValue='Select Calendar'}"
                                   FontSize="16"
                                   Foreground="{DynamicResource ForegroundMuted}"
                                   VerticalAlignment="Center" />
                        <Path Data="M 0 0 L 4 4 L 8 0"
                              Stroke="{DynamicResource ForegroundMuted}"
                              StrokeThickness="1.5"
                              VerticalAlignment="Center"
                              Margin="4,2,0,0" />
                    </StackPanel>
                </Button>
            </Grid>

            <!-- Form Content -->
            <ScrollViewer Grid.Row="1" MaxHeight="500" Padding="1">
                <StackPanel Spacing="16" Margin="2,0,2,8">
                    <StackPanel Spacing="6">
                        <TextBlock Text="Title *"
                                   FontWeight="SemiBold"
                                   FontSize="14"
                                   Foreground="{DynamicResource ForegroundPrimary}" />
                        <TextBox Text="{Binding Title}"
                                 Watermark="Event title"
                                 IsEnabled="{Binding !IsBlockingEvent}" />
                    </StackPanel>

                    <StackPanel Spacing="12">
                        <TextBlock Text="Date &amp; Time *"
                                   FontWeight="SemiBold"
                                   FontSize="14"
                                   Foreground="{DynamicResource ForegroundPrimary}" />

                        <!-- Time Selection Preview -->
                        <controls:TimeSelectionPreview
                            SelectedDate="{Binding Scheduler.SelectedDate}"
                            TimeRangeText="{Binding Scheduler.TimeBlock.TimeRangeText}"
                            DurationText="{Binding Scheduler.TimeBlock.DurationText}"
                            Command="{Binding OpenSchedulerCommand}"
                            IsEnabled="{Binding !IsBlockingEvent}" />

                        <!-- All Day Checkbox -->
                        <CheckBox Content="All day event"
                                  IsChecked="{Binding IsAllDay}"
                                  IsEnabled="{Binding !IsBlockingEvent}" />
                    </StackPanel>


                    <!-- Description -->
                    <StackPanel Spacing="6">
                        <TextBlock Text="Description"
                                   FontWeight="SemiBold"
                                   FontSize="14"
                                   Foreground="{DynamicResource ForegroundPrimary}" />
                        <TextBox Text="{Binding Description}"
                                 Watermark="Add description"
                                 TextWrapping="Wrap"
                                 AcceptsReturn="True"
                                 Height="100"
                                 IsEnabled="{Binding !IsBlockingEvent}" />
                    </StackPanel>
                </StackPanel>
            </ScrollViewer>

            <Grid Grid.Row="2"
                  ColumnDefinitions="Auto,*,Auto,Auto"
                  ColumnSpacing="10"
                  Margin="0,24,0,0">
                <Button Grid.Column="0"
                        Content="Delete"
                        Command="{Binding DeleteCommand}"
                        Classes="danger"
                        MinWidth="100"
                        IsVisible="{Binding IsEditMode}" />

                <Panel Grid.Column="1" />

                <Button Grid.Column="2"
                        Content="Cancel"
                        Command="{Binding CancelCommand}"
                        Classes="modern"
                        MinWidth="100" />

                <Button Grid.Column="3"
                        Content="{Binding SaveButtonText}"
                        Command="{Binding SaveCommand}"
                        Classes="accent"
                        MinWidth="100" />
            </Grid>
        </Grid>
    </Border>
</UserControl>
