<UserControl
    x:Class="Sundy.Uno.Presentation.Controls.CalendarView"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:vm="using:Sundy.Uno.ViewModels"
    xmlns:conv="using:Sundy.Uno.Presentation.Converters"
    mc:Ignorable="d"
    d:DesignHeight="450"
    d:DesignWidth="800">

    <UserControl.Resources>
        <conv:BoolToVisibilityConverter x:Key="BoolToVisibility" />
        <conv:StringToBrushConverter x:Key="ColorConverter" />
        <conv:DateFormatConverter x:Key="DayNameFormat" Format="dddd" />
        <conv:DateFormatConverter x:Key="FullDateFormat" Format="MMMM d, yyyy" />
    </UserControl.Resources>

    <Grid Background="{StaticResource BackgroundPrimary}">
        <!-- Month View -->
        <Grid Visibility="{Binding IsMonthView, Converter={StaticResource BoolToVisibility}}">
            <Grid RowDefinitions="Auto,*">
                <Grid Grid.Row="0" ColumnDefinitions="*,*,*,*,*,*,*" Height="40" Background="{StaticResource BackgroundHover}">
                    <TextBlock Grid.Column="0" Text="Sunday" HorizontalAlignment="Center" VerticalAlignment="Center" Foreground="{StaticResource ForegroundPrimary}" FontWeight="SemiBold" />
                    <TextBlock Grid.Column="1" Text="Monday" HorizontalAlignment="Center" VerticalAlignment="Center" Foreground="{StaticResource ForegroundPrimary}" FontWeight="SemiBold" />
                    <TextBlock Grid.Column="2" Text="Tuesday" HorizontalAlignment="Center" VerticalAlignment="Center" Foreground="{StaticResource ForegroundPrimary}" FontWeight="SemiBold" />
                    <TextBlock Grid.Column="3" Text="Wednesday" HorizontalAlignment="Center" VerticalAlignment="Center" Foreground="{StaticResource ForegroundPrimary}" FontWeight="SemiBold" />
                    <TextBlock Grid.Column="4" Text="Thursday" HorizontalAlignment="Center" VerticalAlignment="Center" Foreground="{StaticResource ForegroundPrimary}" FontWeight="SemiBold" />
                    <TextBlock Grid.Column="5" Text="Friday" HorizontalAlignment="Center" VerticalAlignment="Center" Foreground="{StaticResource ForegroundPrimary}" FontWeight="SemiBold" />
                    <TextBlock Grid.Column="6" Text="Saturday" HorizontalAlignment="Center" VerticalAlignment="Center" Foreground="{StaticResource ForegroundPrimary}" FontWeight="SemiBold" />
                </Grid>

                <ScrollViewer Grid.Row="1">
                    <ItemsControl ItemsSource="{Binding MonthDays}">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <ItemsWrapGrid Orientation="Horizontal" MaximumRowsOrColumns="7" />
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate x:DataType="vm:MonthDayViewModel">
                                <Border BorderBrush="{StaticResource BorderBrush}"
                                        BorderThickness="0,0,1,1"
                                        Padding="10"
                                        MinHeight="100"
                                        MinWidth="120"
                                        Background="{StaticResource BackgroundPrimary}"
                                        DoubleTapped="DayCell_DoubleTapped">
                                    <Grid>
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto" />
                                            <RowDefinition Height="*" />
                                        </Grid.RowDefinitions>
                                        <TextBlock Text="{Binding Day}"
                                                   HorizontalAlignment="Right"
                                                   FontWeight="SemiBold"
                                                   Foreground="{StaticResource ForegroundPrimary}" />
                                        <ListBox Grid.Row="1"
                                                 ItemsSource="{Binding Events}"
                                                 SelectedItem="{Binding SelectedEvent, Mode=TwoWay}"
                                                 Background="Transparent"
                                                 BorderThickness="0"
                                                 SelectionMode="Single">
                                            <ListBox.ItemTemplate>
                                                <DataTemplate x:DataType="vm:EventViewModel">
                                                    <Border Background="{Binding CalendarColor, Converter={StaticResource ColorConverter}}"
                                                            CornerRadius="4"
                                                            Padding="4,2"
                                                            DoubleTapped="Event_DoubleTapped">
                                                        <TextBlock Text="{Binding Title}"
                                                                   Foreground="White"
                                                                   FontSize="11"
                                                                   TextTrimming="CharacterEllipsis" />
                                                    </Border>
                                                </DataTemplate>
                                            </ListBox.ItemTemplate>
                                        </ListBox>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </ScrollViewer>
            </Grid>
        </Grid>

        <!-- Week View -->
        <Grid Visibility="{Binding IsWeekView, Converter={StaticResource BoolToVisibility}}">
            <Grid RowDefinitions="Auto,*">
                <Grid Grid.Row="0" ColumnDefinitions="60,*">
                    <Border Grid.Column="0" Background="{StaticResource BackgroundSecondary}" />
                    <ItemsControl Grid.Column="1" ItemsSource="{Binding WeekDays}">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <ItemsWrapGrid Orientation="Horizontal" MaximumRowsOrColumns="7" />
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate x:DataType="vm:WeekDayViewModel">
                                <StackPanel HorizontalAlignment="Center" Padding="8">
                                    <TextBlock Text="{Binding DayName}" Foreground="{StaticResource ForegroundMuted}" />
                                    <Border Background="{Binding TodayBackground, Converter={StaticResource ColorConverter}}"
                                            CornerRadius="12"
                                            Width="36"
                                            Height="36"
                                            HorizontalAlignment="Center">
                                        <TextBlock Text="{Binding Date}"
                                                   HorizontalAlignment="Center"
                                                   VerticalAlignment="Center"
                                                   Foreground="{Binding TodayForeground}" />
                                    </Border>
                                </StackPanel>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </Grid>

                <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
                    <Grid ColumnDefinitions="60,*" Height="1440">
                        <ItemsControl Grid.Column="0" ItemsSource="{Binding TimeSlots}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate x:DataType="vm:TimeSlotViewModel">
                                    <Border Height="60" BorderBrush="{StaticResource BorderBrush}" BorderThickness="0,0,0,1">
                                        <TextBlock Text="{Binding TimeLabel}"
                                                   VerticalAlignment="Top"
                                                   Margin="4,-6,0,0"
                                                   Foreground="{StaticResource ForegroundMuted}" />
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>

                        <Grid Grid.Column="1">
                            <ItemsControl ItemsSource="{Binding TimeSlots}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate x:DataType="vm:TimeSlotViewModel">
                                        <Grid Height="60" ColumnDefinitions="*,*,*,*,*,*,*">
                                            <Border Grid.Column="0" BorderBrush="{StaticResource BorderBrush}" BorderThickness="0,0,1,1" Background="{StaticResource BackgroundPrimary}" />
                                            <Border Grid.Column="1" BorderBrush="{StaticResource BorderBrush}" BorderThickness="0,0,1,1" Background="{StaticResource BackgroundPrimary}" />
                                            <Border Grid.Column="2" BorderBrush="{StaticResource BorderBrush}" BorderThickness="0,0,1,1" Background="{StaticResource BackgroundPrimary}" />
                                            <Border Grid.Column="3" BorderBrush="{StaticResource BorderBrush}" BorderThickness="0,0,1,1" Background="{StaticResource BackgroundPrimary}" />
                                            <Border Grid.Column="4" BorderBrush="{StaticResource BorderBrush}" BorderThickness="0,0,1,1" Background="{StaticResource BackgroundPrimary}" />
                                            <Border Grid.Column="5" BorderBrush="{StaticResource BorderBrush}" BorderThickness="0,0,1,1" Background="{StaticResource BackgroundPrimary}" />
                                            <Border Grid.Column="6" BorderBrush="{StaticResource BorderBrush}" BorderThickness="0,0,0,1" Background="{StaticResource BackgroundPrimary}" />
                                        </Grid>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>

                            <ItemsControl x:Name="WeekEventsItemsControl" ItemsSource="{Binding VisibleEvents}">
                                <ItemsControl.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <Canvas />
                                    </ItemsPanelTemplate>
                                </ItemsControl.ItemsPanel>
                                <ItemsControl.ItemContainerStyle>
                                    <Style TargetType="ContentPresenter">
                                        <Setter Property="Canvas.Left" Value="{Binding CanvasLeft}" />
                                        <Setter Property="Canvas.Top" Value="{Binding CanvasTop}" />
                                    </Style>
                                </ItemsControl.ItemContainerStyle>
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate x:DataType="vm:EventViewModel">
                                        <Border Background="{Binding CalendarColor, Converter={StaticResource ColorConverter}}"
                                                CornerRadius="6"
                                                Padding="6"
                                                Width="{Binding CanvasWidth}"
                                                Height="{Binding CanvasHeight}"
                                                DoubleTapped="Event_DoubleTapped"
                                                Tapped="Event_Tapped">
                                            <StackPanel>
                                                <TextBlock Text="{Binding Title}" Foreground="White" FontWeight="SemiBold" />
                                                <TextBlock Text="{Binding TimeRange}" Foreground="White" FontSize="12" />
                                            </StackPanel>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </Grid>
                    </Grid>
                </ScrollViewer>
            </Grid>
        </Grid>

        <!-- Day View -->
        <Grid Visibility="{Binding IsDayView, Converter={StaticResource BoolToVisibility}}">
            <Grid RowDefinitions="Auto,*">
                <Border Grid.Row="0" Padding="12" BorderBrush="{StaticResource BorderBrush}" BorderThickness="0,0,0,1" Background="{StaticResource BackgroundSecondary}">
                    <StackPanel HorizontalAlignment="Center">
                        <TextBlock Text="{Binding SelectedDate, Converter={StaticResource DayNameFormat}}" Foreground="{StaticResource ForegroundMuted}" />
                        <TextBlock Text="{Binding SelectedDate, Converter={StaticResource FullDateFormat}}" FontSize="18" FontWeight="SemiBold" Foreground="{StaticResource ForegroundPrimary}" />
                    </StackPanel>
                </Border>

                <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
                    <Grid ColumnDefinitions="60,*" Height="1440">
                        <ItemsControl Grid.Column="0" ItemsSource="{Binding TimeSlots}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate x:DataType="vm:TimeSlotViewModel">
                                    <Border Height="60" BorderBrush="{StaticResource BorderBrush}" BorderThickness="0,0,0,1">
                                        <TextBlock Text="{Binding TimeLabel}" VerticalAlignment="Top" Margin="4,-6,0,0" Foreground="{StaticResource ForegroundMuted}" />
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>

                        <Grid Grid.Column="1">
                            <ItemsControl ItemsSource="{Binding TimeSlots}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate x:DataType="vm:TimeSlotViewModel">
                                        <Border Height="60" BorderBrush="{StaticResource BorderBrush}" BorderThickness="0,0,0,1" Background="{StaticResource BackgroundPrimary}" />
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>

                            <ItemsControl x:Name="DayEventsItemsControl" ItemsSource="{Binding VisibleEvents}">
                                <ItemsControl.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <Canvas />
                                    </ItemsPanelTemplate>
                                </ItemsControl.ItemsPanel>
                                <ItemsControl.ItemContainerStyle>
                                    <Style TargetType="ContentPresenter">
                                        <Setter Property="Canvas.Left" Value="{Binding CanvasLeft}" />
                                        <Setter Property="Canvas.Top" Value="{Binding CanvasTop}" />
                                    </Style>
                                </ItemsControl.ItemContainerStyle>
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate x:DataType="vm:EventViewModel">
                                        <Border Background="{Binding CalendarColor, Converter={StaticResource ColorConverter}}"
                                                CornerRadius="6"
                                                Padding="8"
                                                Width="{Binding CanvasWidth}"
                                                Height="{Binding CanvasHeight}"
                                                DoubleTapped="Event_DoubleTapped"
                                                Tapped="Event_Tapped">
                                            <StackPanel>
                                                <TextBlock Text="{Binding Title}" Foreground="White" FontWeight="SemiBold" />
                                                <TextBlock Text="{Binding TimeRange}" Foreground="White" FontSize="12" />
                                                <TextBlock Text="{Binding Location}" Foreground="White" FontSize="11" Opacity="0.8" Visibility="{Binding HasLocation, Converter={StaticResource BoolToVisibility}}" />
                                            </StackPanel>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </Grid>
                    </Grid>
                </ScrollViewer>
            </Grid>
        </Grid>
    </Grid>
</UserControl>
